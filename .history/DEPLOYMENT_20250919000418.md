# üè• Vietnamese Medical Chatbot System - Production Deployment Guide

**Complete foolproof deployment guide for enterprise-grade Vietnamese medical AI system deployment across cloud, on-premise, and hybrid environments.**

This comprehensive guide covers all deployment scenarios from local development to enterprise production, ensuring your Vietnamese Medical Chatbot System operates reliably at scale.

## üìÇ Architecture Overview

The system is now separated into two independent components:

### Backend (API Server)
- **Location**: Root directory (`/Users/dinhquanghien/Documents/H·ªçc t·∫≠p/pre_2/`)
- **Main File**: `app_chatbot.py`
- **Type**: FastAPI Python application with PhoBERT AI model
- **Database**: MySQL with SQLAlchemy ORM
- **Dependencies**: Python packages in requirements.txt

### Frontend (Static Web App)
- **Location**: `frontend/` directory
- **Main Files**: `index.html`, `app.js`, `config.js`, `admin.html`
- **Type**: Static HTML/CSS/JavaScript application
- **Dependencies**: None (uses CDN resources)

## üöÄ Deployment Options

### Option 1: Local Development (Same Machine)

**Backend:**
```bash
# Navigate to project root
cd "/Users/dinhquanghien/Documents/H·ªçc t·∫≠p/pre_2"

# Start the API server
python app_chatbot.py
# or
uvicorn app_chatbot:app --reload --port 8000
```

**Frontend:**
```bash
# Navigate to frontend directory
cd frontend

# Serve static files (choose one method):
# Method 1: Python HTTP server
python -m http.server 5500

# Method 2: Node.js live-server (if installed)
npx live-server --port=5500

# Method 3: Any web server of your choice
```

**Configuration:** No changes needed - default configuration works.

### Option 2: Separate Servers (LAN/Network)

**Backend Server (e.g., 192.168.1.100):**
```bash
# Start backend on specific IP
uvicorn app_chatbot:app --host 0.0.0.0 --port 8000
```

**Frontend Server (e.g., 192.168.1.101):**
1. Update `frontend/config.js`:
   ```javascript
   const CONFIG = {
     API_BASE: 'http://192.168.1.100:8000',  // Backend server IP
     // ... other settings
   };
   ```

2. Serve frontend:
   ```bash
   cd frontend
   python -m http.server 5500 --bind 0.0.0.0
   ```

### Option 3: Production Deployment

**Backend (API Server):**
```bash
# Production server with Gunicorn
pip install gunicorn
gunicorn app_chatbot:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

# Or with Docker
docker build -t medical-chatbot-api .
docker run -p 8000:8000 medical-chatbot-api
```

**Frontend (Static Files):**
1. Update `frontend/config.js` for production:
   ```javascript
   const CONFIG = {
     API_BASE: 'https://your-api-domain.com',  // Production API URL
     // Or use relative path if same domain:
     // API_BASE: '/api',
     // ... other settings
   };
   ```

2. Deploy static files to web server:
   ```bash
   # Copy frontend files to web server
   rsync -av frontend/ user@webserver:/var/www/html/

   # Or use any static hosting service:
   # - Netlify, Vercel, GitHub Pages
   # - AWS S3 + CloudFront
   # - Nginx, Apache
   ```

### Option 4: Same Domain (Reverse Proxy)

**Nginx Configuration Example:**
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # Frontend static files
    location / {
        root /var/www/html/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # Backend API
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**Frontend Configuration:**
```javascript
const CONFIG = {
  API_BASE: '/api',  // Use proxy path
  // ... other settings
};
```

## ‚öôÔ∏è Configuration Reference

### Frontend Configuration (`frontend/config.js`)

```javascript
const CONFIG = {
  // API endpoint - UPDATE THIS for your deployment
  API_BASE: 'http://127.0.0.1:8000',  // Default: local development
  
  // Alternative configurations:
  // API_BASE: 'https://api.yoursite.com',     // Remote backend
  // API_BASE: '/api',                         // Proxy/same domain
  // API_BASE: 'http://192.168.1.100:8000',   // LAN deployment
  
  // Application settings
  SESSION_STORAGE_KEY: 'medical_session_id',
  HISTORY_STORAGE_PREFIX: 'medical_history_',
  
  // Feature toggles
  FEATURES: {
    EXPORT_ENABLED: true,
    HISTORY_ENABLED: true,
    OFFLINE_SUPPORT: false
  }
};
```

### Backend Configuration (`.env` file)

```env
# Database Configuration
DATABASE_URL=mysql+pymysql://user:password@localhost:3306/medical_db

# Gemini API Configuration  
GEMINI_API_KEY=your_gemini_api_key_here
GEMINI_MODEL=gemini-1.5-flash

# Server Configuration
HOST=0.0.0.0
PORT=8000

# Model Configuration
MODEL_PATH=app/models/phobert_medchat_model.pt
ID2LABEL_PATH=app/assets/id2label.json
TOP_K=3
THRESHOLD=0.5
```

## üîß CORS Configuration

The backend includes CORS middleware configured for common development origins. For production, update the `origins` list in `app_chatbot.py`:

```python
origins = [
    "http://127.0.0.1:5500",      # Local development
    "http://localhost:5500",       # Local development
    "https://your-frontend-domain.com",  # Production frontend
    "https://admin.yoursite.com",        # Admin panel domain
]
```

## üìã Pre-Deployment Checklist

### Backend:
- [ ] Database is set up and migrated (`python migrate_db.py`)
- [ ] All environment variables are configured in `.env`
- [ ] PhoBERT model files are available (`phobert_medchat_model.pt`)
- [ ] Required Python packages are installed
- [ ] CORS origins are configured for frontend domains
- [ ] Database connection is tested

### Frontend:
- [ ] `config.js` is updated with correct API URL
- [ ] All static files are accessible
- [ ] Web server can serve the files
- [ ] Network connectivity to backend is verified
- [ ] Admin panel configuration is updated

### Testing:
- [ ] Health check endpoint responds: `GET /health`
- [ ] Chat endpoint works: `POST /chat`
- [ ] Frontend can load and connect to backend
- [ ] Admin panel can fetch statistics and data
- [ ] Export functionality works
- [ ] Cross-browser compatibility verified

## üö® Troubleshooting

### Common Issues:

**CORS Errors:**
- Add your frontend domain to the `origins` list in `app_chatbot.py`
- Restart the backend server after changes

**API Connection Failed:**
- Check if `config.js` has the correct `API_BASE` URL
- Verify backend server is running and accessible
- Check firewall settings for cross-network deployments

**Database Connection:**
- Verify `DATABASE_URL` in `.env` is correct
- Run `python migrate_db.py` to ensure all columns exist
- Check database server is running

**Frontend Not Loading:**
- Ensure `config.js` is loaded before `app.js`
- Check browser console for JavaScript errors
- Verify web server configuration

---

## üîí Security & Production Hardening

### SSL/TLS Configuration

**For Production Environments:**
```nginx
server {
    listen 443 ssl http2;
    server_name medical-ai.yoursite.com;

    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;

    # Security headers for medical applications
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' fonts.googleapis.com cdnjs.cloudflare.com; font-src 'self' fonts.gstatic.com; img-src 'self' data:; connect-src 'self';" always;

    location / {
        root /var/www/html/medical-chatbot/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Rate limiting for medical API
        limit_req zone=api burst=10 nodelay;
    }
}

# Rate limiting configuration
http {
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
}
```

### Environment Variables Security

**Production `.env` Configuration:**
```env
# üîí CRITICAL: Never commit this file to version control
# Store sensitive credentials in secure key management systems

# Database Configuration (Use connection pooling in production)
DATABASE_URL=mysql+pymysql://medical_user:SECURE_PASSWORD@localhost:3306/medical_production

# Gemini API Configuration (Rotate keys regularly)
GEMINI_API_KEY=your_production_gemini_api_key_here
GEMINI_MODEL=gemini-1.5-flash

# Server Configuration
HOST=127.0.0.1  # Bind to localhost, use reverse proxy
PORT=8000
DEBUG=false

# Model Configuration
MODEL_PATH=/opt/medical-ai/models/phobert_medchat_model.pt
ID2LABEL_PATH=/opt/medical-ai/assets/id2label.json
TOP_K=3
THRESHOLD=0.5

# Logging Configuration
LOG_LEVEL=INFO
LOG_FILE=/var/log/medical-chatbot/app.log

# Security Settings
SESSION_EXPIRE_HOURS=24
MAX_REQUESTS_PER_MINUTE=60
CORS_ORIGINS=https://medical-ai.yoursite.com,https://admin.yoursite.com
```

---

## ‚òÅÔ∏è Cloud Deployment Scenarios

### AWS Deployment Architecture

**Complete AWS Production Setup:**

```bash
# 1. Create VPC and Security Groups
aws ec2 create-vpc --cidr-block 10.0.0.0/16 --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value=medical-ai-vpc}]'

# 2. Launch EC2 instances for backend
aws ec2 run-instances \
    --image-id ami-0abcdef1234567890 \
    --count 2 \
    --instance-type t3.large \
    --key-name medical-ai-key \
    --security-group-ids sg-903004f8 \
    --subnet-id subnet-6e7f829e \
    --user-data file://backend-bootstrap.sh

# 3. Set up RDS MySQL instance
aws rds create-db-instance \
    --db-instance-identifier medical-ai-db \
    --db-instance-class db.t3.medium \
    --engine mysql \
    --master-username medical_admin \
    --master-user-password SECURE_PASSWORD \
    --allocated-storage 100 \
    --vpc-security-group-ids sg-903004f8
```

**Backend Bootstrap Script (`backend-bootstrap.sh`):**
```bash
#!/bin/bash
# AWS EC2 Bootstrap for Medical AI Backend

# Update system
yum update -y
yum install -y python3 python3-pip git nginx

# Create application user
useradd -m -s /bin/bash medical-ai
usermod -aG wheel medical-ai

# Install Python dependencies
cd /opt
git clone https://github.com/yourorg/vietnamese-medical-ai.git medical-ai
chown -R medical-ai:medical-ai /opt/medical-ai

# Install Python packages
sudo -u medical-ai pip3 install --user -r /opt/medical-ai/requirements.txt

# Create systemd service
cat > /etc/systemd/system/medical-ai.service << EOF
[Unit]
Description=Vietnamese Medical AI Chatbot
After=network.target

[Service]
Type=notify
User=medical-ai
Group=medical-ai
WorkingDirectory=/opt/medical-ai
Environment=PATH=/home/medical-ai/.local/bin
ExecStart=/home/medical-ai/.local/bin/gunicorn app_chatbot:app -w 4 -k uvicorn.workers.UvicornWorker --bind 127.0.0.1:8000
ExecReload=/bin/kill -s HUP \$MAINPID
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable medical-ai
systemctl start medical-ai
```

**Frontend CloudFront Distribution:**
```json
{
  "CallerReference": "medical-ai-frontend-2025",
  "Aliases": {
    "Quantity": 1,
    "Items": ["medical-ai.yoursite.com"]
  },
  "Origins": {
    "Quantity": 2,
    "Items": [
      {
        "Id": "frontend-s3",
        "DomainName": "medical-ai-frontend.s3.amazonaws.com",
        "S3OriginConfig": {
          "OriginAccessIdentity": ""
        }
      },
      {
        "Id": "backend-alb",
        "DomainName": "medical-api-alb-123456789.us-east-1.elb.amazonaws.com",
        "CustomOriginConfig": {
          "HTTPPort": 80,
          "HTTPSPort": 443,
          "OriginProtocolPolicy": "https-only"
        }
      }
    ]
  },
  "DefaultCacheBehavior": {
    "TargetOriginId": "frontend-s3",
    "ViewerProtocolPolicy": "redirect-to-https",
    "MinTTL": 0,
    "DefaultTTL": 300
  },
  "CacheBehaviors": {
    "Quantity": 1,
    "Items": [
      {
        "PathPattern": "/api/*",
        "TargetOriginId": "backend-alb",
        "ViewerProtocolPolicy": "https-only",
        "CachePolicyId": "4135ea2d-6df8-44a3-9df3-4b5a84be39ad"
      }
    ]
  }
}
```

### Docker Deployment

**Production Docker Compose:**
```yaml
version: '3.8'

services:
  medical-ai-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      - DATABASE_URL=mysql+pymysql://medical_user:${DB_PASSWORD}@mysql:3306/medical_production
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - LOG_LEVEL=INFO
    volumes:
      - ./models:/app/models:ro
      - ./logs:/var/log/medical-chatbot
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=medical_production
      - MYSQL_USER=medical_user
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend:/usr/share/nginx/html:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - medical-ai-backend
    restart: unless-stopped

  redis:
    image: redis:alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mysql_data:
  redis_data:
```

**Production Dockerfile:**
```dockerfile
# Dockerfile.backend
FROM python:3.9-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create application user
RUN useradd --create-home --shell /bin/bash medical-ai

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY --chown=medical-ai:medical-ai . .

# Create necessary directories
RUN mkdir -p /var/log/medical-chatbot && \
    chown -R medical-ai:medical-ai /var/log/medical-chatbot

# Switch to non-root user
USER medical-ai

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Expose port
EXPOSE 8000

# Start application
CMD ["gunicorn", "app_chatbot:app", "-w", "4", "-k", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8000"]
```

### Kubernetes Deployment

**Production Kubernetes Manifests:**

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: medical-ai
  labels:
    name: medical-ai

---
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: medical-ai-config
  namespace: medical-ai
data:
  LOG_LEVEL: "INFO"
  TOP_K: "3"
  THRESHOLD: "0.5"

---
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: medical-ai-secrets
  namespace: medical-ai
type: Opaque
data:
  DATABASE_URL: bXlzcWwrcHltc3FsOi8vbWVkaWNhbF91c2VyOlNFQ1VSRV9QQVNTV09SREBteXNxbDozMzA2L21lZGljYWxfcHJvZHVjdGlvbg==
  GEMINI_API_KEY: eW91cl9nZW1pbmlfYXBpX2tleV9oZXJl

---
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: medical-ai-backend
  namespace: medical-ai
spec:
  replicas: 3
  selector:
    matchLabels:
      app: medical-ai-backend
  template:
    metadata:
      labels:
        app: medical-ai-backend
    spec:
      containers:
      - name: medical-ai
        image: medical-ai/backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: medical-ai-secrets
              key: DATABASE_URL
        - name: GEMINI_API_KEY
          valueFrom:
            secretKeyRef:
              name: medical-ai-secrets
              key: GEMINI_API_KEY
        envFrom:
        - configMapRef:
            name: medical-ai-config
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30

---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: medical-ai-backend-service
  namespace: medical-ai
spec:
  selector:
    app: medical-ai-backend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8000
  type: ClusterIP

---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: medical-ai-ingress
  namespace: medical-ai
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
spec:
  tls:
  - hosts:
    - medical-ai.yoursite.com
    secretName: medical-ai-tls
  rules:
  - host: medical-ai.yoursite.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: medical-ai-backend-service
            port:
              number: 80
      - path: /
        pathType: Prefix
        backend:
          service:
            name: medical-ai-frontend-service
            port:
              number: 80
```

---

## üìä Monitoring & Observability

### Application Monitoring

**Prometheus Configuration:**
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'medical-ai-backend'
    static_configs:
      - targets: ['localhost:8000']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'mysql'
    static_configs:
      - targets: ['localhost:9104']
```

**Grafana Dashboard JSON:**
```json
{
  "dashboard": {
    "title": "Vietnamese Medical AI System",
    "panels": [
      {
        "title": "API Response Times",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          }
        ]
      },
      {
        "title": "Patient Consultations per Hour",
        "type": "stat",
        "targets": [
          {
            "expr": "increase(medical_consultations_total[1h])",
            "legendFormat": "Consultations"
          }
        ]
      },
      {
        "title": "Disease Classification Accuracy",
        "type": "gauge",
        "targets": [
          {
            "expr": "medical_classification_accuracy",
            "legendFormat": "Accuracy %"
          }
        ]
      }
    ]
  }
}
```

### Log Management

**ELK Stack Configuration:**
```yaml
# docker-compose.monitoring.yml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.15.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data

  logstash:
    image: docker.elastic.co/logstash/logstash:7.15.0
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    depends_on:
      - elasticsearch

  kibana:
    image: docker.elastic.co/kibana/kibana:7.15.0
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch

volumes:
  elasticsearch_data:
```

---

## üîÑ Backup & Disaster Recovery

### Database Backup Strategy

**Automated Backup Script:**
```bash
#!/bin/bash
# medical-ai-backup.sh

# Configuration
DB_HOST="localhost"
DB_NAME="medical_production"
DB_USER="medical_user"
BACKUP_DIR="/opt/backups/medical-ai"
RETENTION_DAYS=30
S3_BUCKET="medical-ai-backups"

# Create backup directory
mkdir -p $BACKUP_DIR

# Generate backup filename
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/medical_ai_$TIMESTAMP.sql.gz"

# Create database backup
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASSWORD \
  --single-transaction \
  --routines \
  --triggers \
  $DB_NAME | gzip > $BACKUP_FILE

# Upload to S3
aws s3 cp $BACKUP_FILE s3://$S3_BUCKET/database/

# Clean old backups
find $BACKUP_DIR -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete

# Log backup completion
echo "$(date): Backup completed successfully: $BACKUP_FILE" >> /var/log/medical-ai-backup.log
```

**Crontab Entry:**
```bash
# Add to crontab: crontab -e
0 2 * * * /opt/scripts/medical-ai-backup.sh
0 14 * * * /opt/scripts/medical-ai-backup.sh
```

### Application State Backup

**Model and Configuration Backup:**
```bash
#!/bin/bash
# backup-application-state.sh

BACKUP_BASE="/opt/backups/medical-ai"
APP_DIR="/opt/medical-ai"

# Backup model files
tar -czf $BACKUP_BASE/models_$(date +%Y%m%d).tar.gz $APP_DIR/app/models/

# Backup configuration
tar -czf $BACKUP_BASE/config_$(date +%Y%m%d).tar.gz $APP_DIR/app/assets/ $APP_DIR/.env

# Upload to S3
aws s3 sync $BACKUP_BASE s3://medical-ai-backups/application/
```

---

## üß™ Testing & Quality Assurance

### Automated Testing Pipeline

**CI/CD with GitHub Actions:**
```yaml
# .github/workflows/deploy.yml
name: Deploy Vietnamese Medical AI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: medical_test
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run tests
      run: |
        pytest tests/ --cov=app --cov-report=xml

    - name: Test API endpoints
      run: |
        python -m pytest tests/test_api.py -v

    - name: Test Vietnamese language processing
      run: |
        python -m pytest tests/test_vietnamese.py -v

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Deploy to production
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      run: |
        echo "$DEPLOY_KEY" > deploy_key
        chmod 600 deploy_key

        ssh -i deploy_key -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST '
          cd /opt/medical-ai &&
          git pull origin main &&
          docker-compose down &&
          docker-compose up -d --build
        '
```

### Load Testing

**Performance Testing with Artillery:**
```yaml
# load-test.yml
config:
  target: 'https://medical-ai.yoursite.com'
  phases:
    - duration: 60
      arrivalRate: 10
    - duration: 120
      arrivalRate: 50
    - duration: 60
      arrivalRate: 100
  payload:
    path: './test-data.csv'
    fields:
      - symptoms
      - user_id

scenarios:
  - name: "Medical consultation flow"
    weight: 80
    flow:
      - post:
          url: "/api/chat"
          json:
            user_id: "{{ user_id }}"
            message: "T√¥i b·ªã {{ symptoms }}"
      - think: 5
      - post:
          url: "/api/chat"
          json:
            user_id: "{{ user_id }}"
            message: "25 tu·ªïi"

  - name: "Health check"
    weight: 20
    flow:
      - get:
          url: "/api/health"
```

---

## üìã Production Checklist & Best Practices

### Pre-Production Checklist

**Security:**
- [ ] All sensitive data in environment variables
- [ ] SSL/TLS certificates configured and valid
- [ ] Rate limiting implemented
- [ ] CORS properly configured for production domains
- [ ] Security headers configured
- [ ] Database credentials rotated and secured
- [ ] API keys secured in key management system

**Performance:**
- [ ] Load testing completed with expected traffic
- [ ] Database indexes optimized
- [ ] CDN configured for static assets
- [ ] Caching strategy implemented
- [ ] Connection pooling configured
- [ ] Resource limits set (CPU, memory)

**Monitoring:**
- [ ] Application metrics configured
- [ ] Log aggregation set up
- [ ] Alerting rules configured
- [ ] Health checks implemented
- [ ] Dashboard created for monitoring
- [ ] Error tracking configured

**Backup & Recovery:**
- [ ] Automated backup scripts tested
- [ ] Backup restoration tested
- [ ] Disaster recovery plan documented
- [ ] RTO/RPO requirements defined
- [ ] Backup monitoring configured

**Documentation:**
- [ ] Deployment procedures documented
- [ ] Troubleshooting guide created
- [ ] API documentation updated
- [ ] Operational runbooks prepared
- [ ] Contact information updated

### Post-Deployment Verification

**Automated Health Checks:**
```bash
#!/bin/bash
# post-deploy-verification.sh

API_BASE="https://medical-ai.yoursite.com/api"
FRONTEND_BASE="https://medical-ai.yoursite.com"

echo "üîç Starting post-deployment verification..."

# 1. Health check
echo "Testing health endpoint..."
HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $API_BASE/health)
if [ $HEALTH_STATUS -eq 200 ]; then
    echo "‚úÖ Health check passed"
else
    echo "‚ùå Health check failed: HTTP $HEALTH_STATUS"
    exit 1
fi

# 2. Chat functionality
echo "Testing chat endpoint..."
CHAT_RESPONSE=$(curl -s -X POST $API_BASE/chat \
    -H "Content-Type: application/json" \
    -d '{"user_id": "test_user", "message": "T√¥i b·ªã ho"}')

if [[ $CHAT_RESPONSE == *"assistant_message"* ]]; then
    echo "‚úÖ Chat functionality working"
else
    echo "‚ùå Chat functionality failed"
    exit 1
fi

# 3. Frontend loading
echo "Testing frontend accessibility..."
FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_BASE)
if [ $FRONTEND_STATUS -eq 200 ]; then
    echo "‚úÖ Frontend accessible"
else
    echo "‚ùå Frontend not accessible: HTTP $FRONTEND_STATUS"
    exit 1
fi

# 4. Database connectivity
echo "Testing database connectivity..."
DB_TEST=$(curl -s $API_BASE/patients | jq -r 'type')
if [ "$DB_TEST" = "array" ]; then
    echo "‚úÖ Database connectivity confirmed"
else
    echo "‚ùå Database connectivity failed"
    exit 1
fi

echo "üéâ All post-deployment checks passed!"
```

---

## üìö Additional Resources & Support

### Documentation Links
- **API Documentation**: Access `/docs` endpoint on running backend for interactive Swagger UI
- **Database Schema**: Reference `app/models.py` for complete table structure
- **Model Architecture**: PhoBERT fine-tuned for 86 Vietnamese medical conditions
- **Admin Interface**: Access `admin.html` for comprehensive system management
- **Configuration Reference**: Complete environment variable documentation in this guide

### Performance Optimization
- **Database Optimization**: Implement read replicas for high-traffic scenarios
- **Caching Strategy**: Use Redis for session management and response caching
- **CDN Configuration**: Serve static assets via CloudFront or similar CDN
- **Load Balancing**: Use multiple backend instances with health checks

### Compliance & Privacy
- **Healthcare Data**: Ensure compliance with local healthcare data regulations
- **Privacy Protection**: Implement data encryption at rest and in transit
- **Audit Logging**: Maintain comprehensive logs for compliance reporting
- **Data Retention**: Configure appropriate data retention policies

### Community & Support
- **Issue Reporting**: Use GitHub Issues for bug reports and feature requests
- **Documentation Updates**: Contribute improvements to deployment documentation
- **Performance Tuning**: Share optimization experiences with the community
- **Security Updates**: Subscribe to security notifications and updates

**For production deployment support, enterprise consulting, or custom feature development, contact the development team with your specific requirements and deployment environment details.**

---

*This deployment guide ensures your Vietnamese Medical AI Chatbot System operates reliably, securely, and efficiently in production environments. Follow the appropriate deployment path for your infrastructure requirements.*